var cov_hf6fyii4b=function(){var path='/usr/src/app/lib/elasticsearch/bulk.js',hash='feec527d29da6f39266239a8997c12fa0ce6ec7b',Function=function(){}.constructor,global=new Function('return this')(),gcv='__coverage__',coverageData={path:'/usr/src/app/lib/elasticsearch/bulk.js',statementMap:{'0':{start:{line:1,column:16},end:{line:1,column:34}},'1':{start:{line:2,column:16},end:{line:2,column:35}},'2':{start:{line:6,column:4},end:{line:6,column:19}},'3':{start:{line:7,column:4},end:{line:7,column:33}},'4':{start:{line:8,column:4},end:{line:9,column:57}},'5':{start:{line:9,column:6},end:{line:9,column:57}},'6':{start:{line:10,column:4},end:{line:10,column:25}},'7':{start:{line:11,column:4},end:{line:11,column:23}},'8':{start:{line:12,column:4},end:{line:12,column:21}},'9':{start:{line:13,column:4},end:{line:13,column:25}},'10':{start:{line:17,column:16},end:{line:17,column:18}},'11':{start:{line:18,column:19},end:{line:18,column:67}},'12':{start:{line:19,column:16},end:{line:21,column:5}},'13':{start:{line:23,column:4},end:{line:23,column:17}},'14':{start:{line:25,column:4},end:{line:28,column:5}},'15':{start:{line:26,column:6},end:{line:26,column:28}},'16':{start:{line:27,column:6},end:{line:27,column:22}},'17':{start:{line:30,column:4},end:{line:33,column:5}},'18':{start:{line:31,column:6},end:{line:31,column:26}},'19':{start:{line:32,column:6},end:{line:32,column:21}},'20':{start:{line:35,column:4},end:{line:38,column:5}},'21':{start:{line:36,column:6},end:{line:36,column:28}},'22':{start:{line:37,column:6},end:{line:37,column:22}},'23':{start:{line:40,column:4},end:{line:43,column:5}},'24':{start:{line:41,column:6},end:{line:41,column:30}},'25':{start:{line:42,column:6},end:{line:42,column:23}},'26':{start:{line:45,column:4},end:{line:45,column:15}},'27':{start:{line:49,column:17},end:{line:70,column:9}},'28':{start:{line:50,column:6},end:{line:57,column:7}},'29':{start:{line:51,column:21},end:{line:51,column:27}},'30':{start:{line:52,column:8},end:{line:52,column:22}},'31':{start:{line:53,column:8},end:{line:53,column:18}},'32':{start:{line:54,column:8},end:{line:55,column:23}},'33':{start:{line:55,column:10},end:{line:55,column:23}},'34':{start:{line:56,column:8},end:{line:56,column:17}},'35':{start:{line:59,column:6},end:{line:59,column:30}},'36':{start:{line:61,column:6},end:{line:61,column:25}},'37':{start:{line:63,column:6},end:{line:68,column:24}},'38':{start:{line:64,column:8},end:{line:64,column:18}},'39':{start:{line:65,column:11},end:{line:68,column:24}},'40':{start:{line:66,column:8},end:{line:66,column:43}},'41':{start:{line:67,column:11},end:{line:68,column:24}},'42':{start:{line:68,column:8},end:{line:68,column:24}},'43':{start:{line:69,column:6},end:{line:69,column:15}},'44':{start:{line:72,column:20},end:{line:109,column:5}},'45':{start:{line:74,column:6},end:{line:93,column:7}},'46':{start:{line:75,column:8},end:{line:84,column:10}},'47':{start:{line:86,column:8},end:{line:86,column:29}},'48':{start:{line:87,column:8},end:{line:88,column:18}},'49':{start:{line:88,column:10},end:{line:88,column:18}},'50':{start:{line:89,column:8},end:{line:90,column:41}},'51':{start:{line:90,column:10},end:{line:90,column:41}},'52':{start:{line:91,column:8},end:{line:91,column:61}},'53':{start:{line:92,column:8},end:{line:92,column:32}},'54':{start:{line:94,column:6},end:{line:95,column:15}},'55':{start:{line:95,column:8},end:{line:95,column:15}},'56':{start:{line:98,column:6},end:{line:98,column:45}},'57':{start:{line:98,column:30},end:{line:98,column:43}},'58':{start:{line:100,column:6},end:{line:101,column:17}},'59':{start:{line:101,column:8},end:{line:101,column:17}},'60':{start:{line:103,column:20},end:{line:107,column:8}},'61':{start:{line:104,column:21},end:{line:104,column:52}},'62':{start:{line:105,column:8},end:{line:105,column:29}},'63':{start:{line:106,column:8},end:{line:106,column:58}},'64':{start:{line:108,column:6},end:{line:108,column:48}},'65':{start:{line:111,column:4},end:{line:111,column:21}},'66':{start:{line:115,column:0},end:{line:115,column:22}}},fnMap:{'0':{name:'(anonymous_0)',decl:{start:{line:5,column:2},end:{line:5,column:3}},loc:{start:{line:5,column:48},end:{line:14,column:3}},line:5},'1':{name:'(anonymous_1)',decl:{start:{line:16,column:2},end:{line:16,column:3}},loc:{start:{line:16,column:13},end:{line:46,column:3}},line:16},'2':{name:'(anonymous_2)',decl:{start:{line:48,column:2},end:{line:48,column:3}},loc:{start:{line:48,column:9},end:{line:112,column:3}},line:48},'3':{name:'(anonymous_3)',decl:{start:{line:49,column:37},end:{line:49,column:38}},loc:{start:{line:49,column:46},end:{line:70,column:5}},line:49},'4':{name:'(anonymous_4)',decl:{start:{line:72,column:20},end:{line:72,column:21}},loc:{start:{line:72,column:35},end:{line:109,column:5}},line:72},'5':{name:'(anonymous_5)',decl:{start:{line:98,column:22},end:{line:98,column:23}},loc:{start:{line:98,column:30},end:{line:98,column:43}},line:98},'6':{name:'(anonymous_6)',decl:{start:{line:103,column:35},end:{line:103,column:36}},loc:{start:{line:103,column:40},end:{line:107,column:7}},line:103}},branchMap:{'0':{loc:{start:{line:7,column:19},end:{line:7,column:32}},type:'binary-expr',locations:[{start:{line:7,column:19},end:{line:7,column:26}},{start:{line:7,column:30},end:{line:7,column:32}}],line:7},'1':{loc:{start:{line:8,column:4},end:{line:9,column:57}},type:'if',locations:[{start:{line:8,column:4},end:{line:9,column:57}},{start:{line:8,column:4},end:{line:9,column:57}}],line:8},'2':{loc:{start:{line:18,column:19},end:{line:18,column:67}},type:'cond-expr',locations:[{start:{line:18,column:45},end:{line:18,column:53}},{start:{line:18,column:56},end:{line:18,column:67}}],line:18},'3':{loc:{start:{line:25,column:4},end:{line:28,column:5}},type:'if',locations:[{start:{line:25,column:4},end:{line:28,column:5}},{start:{line:25,column:4},end:{line:28,column:5}}],line:25},'4':{loc:{start:{line:30,column:4},end:{line:33,column:5}},type:'if',locations:[{start:{line:30,column:4},end:{line:33,column:5}},{start:{line:30,column:4},end:{line:33,column:5}}],line:30},'5':{loc:{start:{line:35,column:4},end:{line:38,column:5}},type:'if',locations:[{start:{line:35,column:4},end:{line:38,column:5}},{start:{line:35,column:4},end:{line:38,column:5}}],line:35},'6':{loc:{start:{line:40,column:4},end:{line:43,column:5}},type:'if',locations:[{start:{line:40,column:4},end:{line:43,column:5}},{start:{line:40,column:4},end:{line:43,column:5}}],line:40},'7':{loc:{start:{line:50,column:6},end:{line:57,column:7}},type:'if',locations:[{start:{line:50,column:6},end:{line:57,column:7}},{start:{line:50,column:6},end:{line:57,column:7}}],line:50},'8':{loc:{start:{line:54,column:8},end:{line:55,column:23}},type:'if',locations:[{start:{line:54,column:8},end:{line:55,column:23}},{start:{line:54,column:8},end:{line:55,column:23}}],line:54},'9':{loc:{start:{line:61,column:10},end:{line:61,column:24}},type:'binary-expr',locations:[{start:{line:61,column:10},end:{line:61,column:19}},{start:{line:61,column:23},end:{line:61,column:24}}],line:61},'10':{loc:{start:{line:63,column:6},end:{line:68,column:24}},type:'if',locations:[{start:{line:63,column:6},end:{line:68,column:24}},{start:{line:63,column:6},end:{line:68,column:24}}],line:63},'11':{loc:{start:{line:65,column:11},end:{line:68,column:24}},type:'if',locations:[{start:{line:65,column:11},end:{line:68,column:24}},{start:{line:65,column:11},end:{line:68,column:24}}],line:65},'12':{loc:{start:{line:67,column:11},end:{line:68,column:24}},type:'if',locations:[{start:{line:67,column:11},end:{line:68,column:24}},{start:{line:67,column:11},end:{line:68,column:24}}],line:67},'13':{loc:{start:{line:86,column:17},end:{line:86,column:27}},type:'binary-expr',locations:[{start:{line:86,column:17},end:{line:86,column:22}},{start:{line:86,column:26},end:{line:86,column:27}}],line:86},'14':{loc:{start:{line:87,column:8},end:{line:88,column:18}},type:'if',locations:[{start:{line:87,column:8},end:{line:88,column:18}},{start:{line:87,column:8},end:{line:88,column:18}}],line:87},'15':{loc:{start:{line:87,column:12},end:{line:87,column:71}},type:'binary-expr',locations:[{start:{line:87,column:12},end:{line:87,column:36}},{start:{line:87,column:40},end:{line:87,column:71}}],line:87},'16':{loc:{start:{line:89,column:8},end:{line:90,column:41}},type:'if',locations:[{start:{line:89,column:8},end:{line:90,column:41}},{start:{line:89,column:8},end:{line:90,column:41}}],line:89},'17':{loc:{start:{line:91,column:28},end:{line:91,column:60}},type:'binary-expr',locations:[{start:{line:91,column:28},end:{line:91,column:51}},{start:{line:91,column:55},end:{line:91,column:60}}],line:91},'18':{loc:{start:{line:94,column:6},end:{line:95,column:15}},type:'if',locations:[{start:{line:94,column:6},end:{line:95,column:15}},{start:{line:94,column:6},end:{line:95,column:15}}],line:94},'19':{loc:{start:{line:94,column:10},end:{line:94,column:62}},type:'binary-expr',locations:[{start:{line:94,column:10},end:{line:94,column:34}},{start:{line:94,column:38},end:{line:94,column:62}}],line:94},'20':{loc:{start:{line:100,column:6},end:{line:101,column:17}},type:'if',locations:[{start:{line:100,column:6},end:{line:101,column:17}},{start:{line:100,column:6},end:{line:101,column:17}}],line:100},'21':{loc:{start:{line:104,column:21},end:{line:104,column:52}},type:'binary-expr',locations:[{start:{line:104,column:21},end:{line:104,column:29}},{start:{line:104,column:33},end:{line:104,column:40}},{start:{line:104,column:44},end:{line:104,column:52}}],line:104},'22':{loc:{start:{line:106,column:15},end:{line:106,column:57}},type:'binary-expr',locations:[{start:{line:106,column:15},end:{line:106,column:34}},{start:{line:106,column:38},end:{line:106,column:57}}],line:106},'23':{loc:{start:{line:108,column:13},end:{line:108,column:47}},type:'binary-expr',locations:[{start:{line:108,column:13},end:{line:108,column:25}},{start:{line:108,column:29},end:{line:108,column:34}},{start:{line:108,column:38},end:{line:108,column:47}}],line:108}},s:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0,'7':0,'8':0,'9':0,'10':0,'11':0,'12':0,'13':0,'14':0,'15':0,'16':0,'17':0,'18':0,'19':0,'20':0,'21':0,'22':0,'23':0,'24':0,'25':0,'26':0,'27':0,'28':0,'29':0,'30':0,'31':0,'32':0,'33':0,'34':0,'35':0,'36':0,'37':0,'38':0,'39':0,'40':0,'41':0,'42':0,'43':0,'44':0,'45':0,'46':0,'47':0,'48':0,'49':0,'50':0,'51':0,'52':0,'53':0,'54':0,'55':0,'56':0,'57':0,'58':0,'59':0,'60':0,'61':0,'62':0,'63':0,'64':0,'65':0,'66':0},f:{'0':0,'1':0,'2':0,'3':0,'4':0,'5':0,'6':0},b:{'0':[0,0],'1':[0,0],'2':[0,0],'3':[0,0],'4':[0,0],'5':[0,0],'6':[0,0],'7':[0,0],'8':[0,0],'9':[0,0],'10':[0,0],'11':[0,0],'12':[0,0],'13':[0,0],'14':[0,0],'15':[0,0],'16':[0,0],'17':[0,0],'18':[0,0],'19':[0,0],'20':[0,0],'21':[0,0,0],'22':[0,0],'23':[0,0,0]},_coverageSchema:'332fd63041d2c1bcb487cc26dd0d5f7d97098a6c'},coverage=global[gcv]||(global[gcv]={});if(coverage[path]&&coverage[path].hash===hash){return coverage[path];}coverageData.hash=hash;return coverage[path]=coverageData;}();const Streamz=(cov_hf6fyii4b.s[0]++,require('streamz'));const Promise=(cov_hf6fyii4b.s[1]++,require('bluebird'));class Bulk extends(Streamz){constructor(action,client,index,type,options){cov_hf6fyii4b.f[0]++;cov_hf6fyii4b.s[2]++;super(options);cov_hf6fyii4b.s[3]++;this.options=(cov_hf6fyii4b.b[0][0]++,options)||(cov_hf6fyii4b.b[0][1]++,{});cov_hf6fyii4b.s[4]++;if(this.options.pushResult)// legacy fix
{cov_hf6fyii4b.b[1][0]++;cov_hf6fyii4b.s[5]++;this.options.pushResults=this.options.pushResult;}else{cov_hf6fyii4b.b[1][1]++;}cov_hf6fyii4b.s[6]++;this.action=action;cov_hf6fyii4b.s[7]++;this.index=index;cov_hf6fyii4b.s[8]++;this.type=type;cov_hf6fyii4b.s[9]++;this.client=client;}getMeta(d){cov_hf6fyii4b.f[1]++;const res=(cov_hf6fyii4b.s[10]++,{});const action=(cov_hf6fyii4b.s[11]++,this.action=='upsert'?(cov_hf6fyii4b.b[2][0]++,'update'):(cov_hf6fyii4b.b[2][1]++,this.action));const obj=(cov_hf6fyii4b.s[12]++,res[action]={_id:d._id});cov_hf6fyii4b.s[13]++;delete d._id;cov_hf6fyii4b.s[14]++;if(!this.index){cov_hf6fyii4b.b[3][0]++;cov_hf6fyii4b.s[15]++;obj._index=d._index;cov_hf6fyii4b.s[16]++;delete d._index;}else{cov_hf6fyii4b.b[3][1]++;}cov_hf6fyii4b.s[17]++;if(!this.type){cov_hf6fyii4b.b[4][0]++;cov_hf6fyii4b.s[18]++;obj._type=d._type;cov_hf6fyii4b.s[19]++;delete d._type;}else{cov_hf6fyii4b.b[4][1]++;}cov_hf6fyii4b.s[20]++;if(!this.parent){cov_hf6fyii4b.b[5][0]++;cov_hf6fyii4b.s[21]++;obj.parent=d.parent;cov_hf6fyii4b.s[22]++;delete d.parent;}else{cov_hf6fyii4b.b[5][1]++;}cov_hf6fyii4b.s[23]++;if(!this.routing){cov_hf6fyii4b.b[6][0]++;cov_hf6fyii4b.s[24]++;obj.routing=d.routing;cov_hf6fyii4b.s[25]++;delete d.routing;}else{cov_hf6fyii4b.b[6][1]++;}cov_hf6fyii4b.s[26]++;return res;}_fn(d){cov_hf6fyii4b.f[2]++;const data=(cov_hf6fyii4b.s[27]++,[].concat(d).reduce((p,d)=>{cov_hf6fyii4b.f[3]++;cov_hf6fyii4b.s[28]++;if(this.action=='custom'){cov_hf6fyii4b.b[7][0]++;const body=(cov_hf6fyii4b.s[29]++,d.body);cov_hf6fyii4b.s[30]++;delete d.body;cov_hf6fyii4b.s[31]++;p.push(d);cov_hf6fyii4b.s[32]++;if(body){cov_hf6fyii4b.b[8][0]++;cov_hf6fyii4b.s[33]++;p.push(body);}else{cov_hf6fyii4b.b[8][1]++;}cov_hf6fyii4b.s[34]++;return p;}else{cov_hf6fyii4b.b[7][1]++;}cov_hf6fyii4b.s[35]++;p.push(this.getMeta(d));cov_hf6fyii4b.s[36]++;d=(cov_hf6fyii4b.b[9][0]++,d._source)||(cov_hf6fyii4b.b[9][1]++,d);cov_hf6fyii4b.s[37]++;if(this.action=='index'){cov_hf6fyii4b.b[10][0]++;cov_hf6fyii4b.s[38]++;p.push(d);}else{cov_hf6fyii4b.b[10][1]++;cov_hf6fyii4b.s[39]++;if(this.action=='upsert'){cov_hf6fyii4b.b[11][0]++;cov_hf6fyii4b.s[40]++;p.push({doc:d,doc_as_upsert:true});}else{cov_hf6fyii4b.b[11][1]++;cov_hf6fyii4b.s[41]++;if(this.action=='update'){cov_hf6fyii4b.b[12][0]++;cov_hf6fyii4b.s[42]++;p.push({doc:d});}else{cov_hf6fyii4b.b[12][1]++;}}}cov_hf6fyii4b.s[43]++;return p;},[]));cov_hf6fyii4b.s[44]++;const execute=async retry=>{cov_hf6fyii4b.f[4]++;let d;cov_hf6fyii4b.s[45]++;try{cov_hf6fyii4b.s[46]++;d=await this.client.bulk({body:data,index:this.index,type:this.type,consistency:this.options.consistency,refresh:this.options.refresh,routing:this.options.routing,timeout:this.options.timeout,fields:this.options.fields});}catch(e){cov_hf6fyii4b.s[47]++;retry=(cov_hf6fyii4b.b[13][0]++,retry)||(cov_hf6fyii4b.b[13][1]++,0);cov_hf6fyii4b.s[48]++;if((cov_hf6fyii4b.b[15][0]++,!this.options.maxRetries)||(cov_hf6fyii4b.b[15][1]++,retry>this.options.maxRetries)){cov_hf6fyii4b.b[14][0]++;cov_hf6fyii4b.s[49]++;throw e;}else{cov_hf6fyii4b.b[14][1]++;}cov_hf6fyii4b.s[50]++;if(this.options.debug){cov_hf6fyii4b.b[16][0]++;cov_hf6fyii4b.s[51]++;console.log('Retry',e.message);}else{cov_hf6fyii4b.b[16][1]++;}cov_hf6fyii4b.s[52]++;await Promise.delay((cov_hf6fyii4b.b[17][0]++,this.options.retryDelay)||(cov_hf6fyii4b.b[17][1]++,30000));cov_hf6fyii4b.s[53]++;return execute(retry++);}cov_hf6fyii4b.s[54]++;if((cov_hf6fyii4b.b[19][0]++,!this.options.pushResult)&&(cov_hf6fyii4b.b[19][1]++,!this.options.pushErrors)){cov_hf6fyii4b.b[18][0]++;cov_hf6fyii4b.s[55]++;return;}else{cov_hf6fyii4b.b[18][1]++;}// Insert a copy of the original body
cov_hf6fyii4b.s[56]++;d.items.forEach((e,i)=>{cov_hf6fyii4b.f[5]++;cov_hf6fyii4b.s[57]++;return e.body=d[i];});cov_hf6fyii4b.s[58]++;if(this.options.pushResults){cov_hf6fyii4b.b[20][0]++;cov_hf6fyii4b.s[59]++;return d;}else{cov_hf6fyii4b.b[20][1]++;}const items=(cov_hf6fyii4b.s[60]++,d.items.filter(d=>{cov_hf6fyii4b.f[6]++;const verb=(cov_hf6fyii4b.s[61]++,(cov_hf6fyii4b.b[21][0]++,d.update)||(cov_hf6fyii4b.b[21][1]++,d.index)||(cov_hf6fyii4b.b[21][2]++,d.create));cov_hf6fyii4b.s[62]++;d.error=verb.error;cov_hf6fyii4b.s[63]++;return(cov_hf6fyii4b.b[22][0]++,verb.status!==201)&&(cov_hf6fyii4b.b[22][1]++,verb.status!==200);}));cov_hf6fyii4b.s[64]++;return(cov_hf6fyii4b.b[23][0]++,items.length)&&(cov_hf6fyii4b.b[23][1]++,items)||(cov_hf6fyii4b.b[23][2]++,undefined);};cov_hf6fyii4b.s[65]++;return execute();}}cov_hf6fyii4b.s[66]++;module.exports=Bulk;